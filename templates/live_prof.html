<html>

<head>
   <title>VisualisationProf</title>
   {% include 'includes/head_common.html' %}
   {% include 'includes/head_visualiser.html' %}
   <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css" rel="stylesheet" />
   <script src="https://code.jquery.com/jquery-3.6.3.min.js"
      integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
   <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"
      integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
      crossorigin="anonymous"></script>
   <script>
      var socket;
      window.onload = function () {
         socket = io.connect('https://' + location.host);
         socket.emit('connect-prof', { "sequence_id": "{{ sequence.id_unique }}" });

         socket.on('connect-etu', function (data) {
            $('#etu-count').text(data['count']);
         });

         socket.on('display-question', function (data) {
            console.log(data);
            display(data);
         });

         socket.on('refresh-answers', function (data) {
            console.log(data);
            refreshAnswers(data);
         });
      };

      function refreshAnswers(data) {
         if (data['type'] == 'Alphanumerique') {
            answers.innerHTML = '';
            var btndiv = document.createElement('div');
            btndiv.className = 'answer form-check form-switch';
            var btn = document.createElement('input');
            btn.className = 'isCorrect form-check-input answers-btn';
            btn.type = 'checkbox';
            btn.name = 'correct';
            btn.id = 'flexSwitchCheckDefault';
            btn.checked = true;
            btndiv.appendChild(btn);
            answers.appendChild(btndiv);

            for (let reponse in data["answers"]) {
               var nbReponses = data["answers"][reponse];
               var input = creerAlphanumeriqueInput(reponse, nbReponses, data["total"]);
               answers.appendChild(input);
            }

         } else if (data['type'] == 'ChoixMultiple') {
            for (var i = 0; i < Object.keys(data["answers"]).length; i++) {
               var nbReponses = data["answers"][i];
               if (data["total"] == 0)
                  var pourcentage = 0;
               else
                  var pourcentage = nbReponses / data["total"] * 100;
               console.log("reponse " + i + ", % : " + pourcentage);
               var progressBar = document.getElementById("progress-bar" + i);
               progressBar.style.width = pourcentage + '%';
               progressBar.setAttribute('aria-valuenow', pourcentage);
            }
         }
      }

      function stopReponses() {
         socket.emit('stop-answers', { "sequence_id": "{{ sequence.id_unique }}" });
      }

      function nextQuestion() {
         socket.emit('next-question', { "sequence_id": "{{ sequence.id_unique }}" });
      }

      function creerProgressBar(pourcentage, id) {
         var progress = document.createElement('div');
         progress.className = 'progress';
         progress.style.width = '80%';
         progress.style.margin = '12px';
         var progressBar = document.createElement('div');
         progressBar.className = 'progress-bar';
         progressBar.role = 'progressbar';
         progressBar.id = "progress-bar" + id;
         progressBar.style.width = pourcentage + '%';
         progressBar.setAttribute('aria-valuenow', pourcentage);
         progressBar.setAttribute('aria-valuemin', '0');
         progressBar.setAttribute('aria-valuemax', '100');
         progress.appendChild(progressBar);
         return progress;
      }

      function creerAlphanumeriqueInput(reponse, nb, total) {
         var pourcentage = (nb / total) * 100;

         var input = document.createElement('input');
         input.type = 'text';
         input.className = 'form-control answer-js';
         input.id = 'reponse';
         input.name = 'reponse';
         input.readOnly = true;
         input.value = reponse;
         answers.appendChild(input);

         var progress = creerProgressBar(pourcentage);
         answers.appendChild(progress, "");
         return input;
      }

      function creerChoixMultipleInput(reponse, id, nb, total) {
         var pourcentage = (nb / total) * 100;

         var div = document.createElement('div');
         div.className = 'answer form-check form-switch answer-js flex-col-center-center';
         div.style.padding = '10px';

         var answ = document.createElement('div');
         answ.className = 'answer-html';
         answ.innerHTML = reponse;
         div.appendChild(answ);

         var progress = creerProgressBar(pourcentage, id);
         div.appendChild(progress);

         MathJax.typeset([answ]);

         return div;
      }

      function display(question) {
         // Afficher Suivant ou Terminet sur le bouton
         var next_button = document.getElementById('next_button');
         if (question['position'] < question['total']) {
            next_button.textContent = 'Suivant';
         } else {
            next_button.textContent = 'Terminer';
         }
         // Affichage du N° de la question courante
         var questionNb = document.getElementById('question-nb');
         questionNb.textContent = question['position'];
         // Affichage de la question
         var qst = document.getElementById('qst');
         qst.innerHTML = question['question']['text'];
         // Affichage des réponses
         var answers = document.getElementById('answers');

         answers.innerHTML = '';
         var btndiv = document.createElement('div');
         btndiv.className = 'answer form-check form-switch';
         var btn = document.createElement('input');
         btn.className = 'isCorrect form-check-input answers-btn';
         btn.type = 'checkbox';
         btn.name = 'correct';
         btn.id = 'flexSwitchCheckDefault';
         btn.checked = true;
         btndiv.appendChild(btn);
         answers.appendChild(btndiv);

         var type = question['question']['type'];
         if (type == "ChoixMultiple") {
            for (var i = 0; i < question['question']['answers'].length; i++) {
               var reponse = question['question']['answers'][i]['text'];
               
               var input = creerChoixMultipleInput(reponse, i, 0, 100);
               answers.appendChild(input);
            }
         } else {
            answers.appendChild(creerAlphanumeriqueInput("Saisissez vos réponses", 0, 100));
         }
         mermaid.init();
      }
   </script>
</head>

<body>
   <div>
      <div class="container-fluid bg-dark text-light py-3">
         <header class="text-center">
            <h1 class="display-6">VisualisationProf</h1>
            {% if length > 1 %}
            <h2 class="display-6">Code de la sequence : {{ sequence.id_unique }}</h2>
            {% else %}
            <h2 class="display-6">Code de la question : {{ questions[0].id }}</h2>
            {% endif %}
            <h3>Nombre d'étudiants connectés : <strong id="etu-count">0</strong></h2>
         </header>
      </div>
   </div>
   <center>
      <div class="row-container">

         <div class="card bg-dark col-4 question" id="card">
            <div class="card-body flex-col-center-center">
               <div style="align-items: center;  width: 100%">
                  <h6 id="question-titre" class="card-subtitle mb-2 text-muted">Titre question ???</h6>
                  <button type="button" id="next_button" class="btn btn-outline-success"
                     style="float :right; display:block;position: absolute; top:0;right: 0;"><i
                        class="bi bi-arrow-right-circle"></i> Salut (test) </button>
               </div>
               <div>
                  <label for="qst" class="text-light">Question <strong id="question-nb" class="text-light">0</strong> :</label>
               </div>

               <div id="qst" name="text"
                  style="background-color: #EBFCCB; border-radius: 15px; color:black; height: auto; min-height: 100px; width: 300px; display: flex; text-align: center; justify-content: center; flex-direction:column;">
                  <div class="answer form-check form-switch">
                     <input class="isCorrect form-check-input" type="checkbox" name="correct"
                        id="flexSwitchCheckDefault"
                        style="float :right; display:block;position: relative; top:0;right: 0;" checked>
                  </div>
               </div>
            </div>

            <div id="answers" class="container my-2 bg-dark w-80 text-light p-2" style="display:flex; flex-direction: column;justify-content: center;align-items: center; padding: 10px;">
            </div>
            <button onclick="stopReponses()">Stopper les réponses et afficher la correction</button>
      </div>
   </center>

   <script>
      mermaid.initialize({
         startOnLoad: true
      });
      /*
      var currentContent = 0;
      var next_button = document.getElementById("next_button");
      var prevBtn = document.getElementById("prevBtn");
      var contentList = document.getElementsByClassName("card");
      */
      var next_button = document.getElementById('next_button');
      next_button.addEventListener("click", function () {
         console.log('click');
         nextQuestion();
      });
   
   </script>


</body>

</html>